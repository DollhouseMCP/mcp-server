#!/bin/bash

# GitFlow Guardian - Pre-commit Hook
# Prevents direct commits to protected branches and enforces GitFlow
# 
# Protected branches:
# - main (production)
# - develop (integration)
# 
# Allowed branches:
# - feature/* (new features)
# - fix/* or bugfix/* (bug fixes)
# - hotfix/* (urgent production fixes)
# - release/* (release preparation)

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get current branch name
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# Check if we're on a protected branch
if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]] || [[ "$BRANCH" == "develop" ]]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                   ğŸš¨ GITFLOW VIOLATION DETECTED ğŸš¨              â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  You are attempting to commit directly to: ${YELLOW}$BRANCH${RED}              â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  This violates GitFlow best practices!                          â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  ${YELLOW}What you should do instead:${RED}                                   â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  1. Create a feature branch:                                    â•‘${NC}"
    echo -e "${RED}â•‘     ${GREEN}git checkout -b feature/your-feature-name${RED}                  â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  2. Or a fix branch:                                            â•‘${NC}"
    echo -e "${RED}â•‘     ${GREEN}git checkout -b fix/your-fix-description${RED}                   â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  3. Commit your changes there                                   â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  4. Push and create a Pull Request                              â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  ${YELLOW}If you REALLY need to commit here (emergency only):${RED}           â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  Use --no-verify flag:                                          â•‘${NC}"
    echo -e "${RED}â•‘     ${BLUE}git commit --no-verify -m \"Emergency: reason\"${RED}              â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  âš ï¸  This should be rare and documented!                        â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Commit aborted. Please use a feature branch.${NC}"
    exit 1
fi

# Check if branch follows GitFlow naming convention
if [[ ! "$BRANCH" =~ ^(feature|fix|bugfix|hotfix|release|support|docs|test|chore|refactor)/.+ ]]; then
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘                    âš ï¸  GITFLOW WARNING âš ï¸                        â•‘${NC}"
    echo -e "${YELLOW}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•‘  Current branch: ${BLUE}$BRANCH${YELLOW}                                        â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•‘  This branch doesn't follow GitFlow naming conventions.         â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•‘  Recommended prefixes:                                          â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ feature/  - New features                                   â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ fix/      - Bug fixes                                      â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ hotfix/   - Urgent production fixes                        â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ release/  - Release preparation                            â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ docs/     - Documentation only                             â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ test/     - Test additions/fixes                           â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ chore/    - Maintenance tasks                              â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}Proceeding with commit (non-standard branch name)...${NC}"
fi

# If we get here, the commit is allowed
echo -e "${GREEN}âœ… GitFlow check passed. Branch '$BRANCH' is valid for direct commits.${NC}"