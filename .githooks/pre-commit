#!/bin/bash

# GitFlow Guardian - Pre-commit Hook
# Prevents direct commits to protected branches and enforces GitFlow

# Get the directory where this hook is located
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration if it exists
CONFIG_FILE="$HOOK_DIR/config"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
    # Default configuration if config file doesn't exist
    PROTECTED_BRANCHES=("main" "master" "develop")
    ALLOWED_PREFIXES=("feature" "fix" "bugfix" "hotfix" "release" "support" "docs" "test" "chore" "refactor")
    MIN_NAME_LENGTH=1
    USE_COLORS=true
    ENABLE_COMMIT_PROTECTION=true
fi

# Exit early if protection is disabled
if [ "$ENABLE_COMMIT_PROTECTION" != "true" ]; then
    exit 0
fi

# Colors for output (only if enabled)
if [ "$USE_COLORS" = "true" ]; then
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    GREEN='\033[0;32m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    YELLOW=''
    GREEN=''
    BLUE=''
    NC=''
fi

# Get current branch name
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# Check if we're on a protected branch
IS_PROTECTED=false
for protected_branch in "${PROTECTED_BRANCHES[@]}"; do
    if [[ "$BRANCH" == "$protected_branch" ]]; then
        IS_PROTECTED=true
        break
    fi
done

if [ "$IS_PROTECTED" = "true" ]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                   ğŸš¨ GITFLOW VIOLATION DETECTED ğŸš¨              â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  You are attempting to commit directly to: ${YELLOW}$BRANCH${RED}              â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  This violates GitFlow best practices!                          â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  ${YELLOW}What you should do instead:${RED}                                   â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  1. Create a feature branch:                                    â•‘${NC}"
    echo -e "${RED}â•‘     ${GREEN}git checkout -b feature/your-feature-name${RED}                  â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  2. Or a fix branch:                                            â•‘${NC}"
    echo -e "${RED}â•‘     ${GREEN}git checkout -b fix/your-fix-description${RED}                   â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  3. Commit your changes there                                   â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  4. Push and create a Pull Request                              â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  ${YELLOW}If you REALLY need to commit here (emergency only):${RED}           â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  Use --no-verify flag:                                          â•‘${NC}"
    echo -e "${RED}â•‘     ${BLUE}git commit --no-verify -m \"Emergency: reason\"${RED}              â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•‘  âš ï¸  This should be rare and documented!                        â•‘${NC}"
    echo -e "${RED}â•‘                                                                  â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Commit aborted. Please use a feature branch.${NC}"
    exit 1
fi

# Build regex pattern from allowed prefixes
PREFIX_PATTERN=$(IFS='|'; echo "${ALLOWED_PREFIXES[*]}")

# Check if branch follows GitFlow naming convention
if [[ ! "$BRANCH" =~ ^($PREFIX_PATTERN)/.{$MIN_NAME_LENGTH,} ]]; then
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘                    âš ï¸  GITFLOW WARNING âš ï¸                        â•‘${NC}"
    echo -e "${YELLOW}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•‘  Current branch: ${BLUE}$BRANCH${YELLOW}                                        â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•‘  This branch doesn't follow GitFlow naming conventions.         â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•‘  Recommended prefixes:                                          â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ feature/  - New features                                   â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ fix/      - Bug fixes                                      â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ hotfix/   - Urgent production fixes                        â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ release/  - Release preparation                            â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ docs/     - Documentation only                             â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ test/     - Test additions/fixes                           â•‘${NC}"
    echo -e "${YELLOW}â•‘    â€¢ chore/    - Maintenance tasks                              â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                                  â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}Proceeding with commit (non-standard branch name)...${NC}"
fi

# If we get here, the commit is allowed
echo -e "${GREEN}âœ… GitFlow check passed. Branch '$BRANCH' is valid for direct commits.${NC}"