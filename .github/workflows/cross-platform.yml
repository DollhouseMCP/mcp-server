name: Cross-Platform Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Manual trigger
  schedule:
    # Weekly compatibility check (Sundays at 2 AM UTC)
    - cron: '0 2 * * 0'

env:
  # Test configuration
  NODE_OPTIONS: --max-old-space-size=4096
  CI: true

jobs:
  # Matrix strategy for comprehensive platform coverage
  cross-platform-test:
    name: Test on ${{ matrix.os }} with Node ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    
    strategy:
      fail-fast: false  # Continue testing other platforms even if one fails
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18.x', '20.x', '22.x']
        include:
          # Platform-specific configurations
          - os: ubuntu-latest
            platform: linux
            shell: bash
          - os: windows-latest  
            platform: windows
            shell: pwsh
          - os: macos-latest
            platform: macos
            shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 1  # Shallow clone for faster CI

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # v4.1.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # Platform detection and system info
      - name: Display system information
        shell: ${{ matrix.shell }}
        run: |
          echo "üñ•Ô∏è System Information for ${{ matrix.platform }}"
          echo "=================================="
          echo "OS: ${{ matrix.os }}"
          echo "Platform: ${{ matrix.platform }}"
          echo "Shell: ${{ matrix.shell }}"
          echo "Node.js: ${{ matrix.node-version }}"
          echo "Runner: ${{ runner.os }}"
          echo "=================================="

      - name: Display system information (Windows details)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Write-Output "Windows Version: $((Get-CimInstance Win32_OperatingSystem).Caption)"
          Write-Output "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Output "Architecture: $env:PROCESSOR_ARCHITECTURE"

      - name: Display system information (Unix details) 
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          echo "Kernel: $(uname -srm)"
          echo "Shell: $SHELL"
          echo "User: $(whoami)"

      # Dependency verification with enhanced version checking
      - name: Verify dependencies (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Write-Output "üîç Verifying system dependencies..."
          
          # Check Node.js
          $nodeVersion = node --version
          Write-Output "‚úÖ Node.js: $nodeVersion"
          
          # Check npm
          $npmVersion = npm --version
          Write-Output "‚úÖ npm: $npmVersion"
          
          # Check git
          try {
            $gitVersion = git --version
            Write-Output "‚úÖ git: $gitVersion"
          } catch {
            Write-Output "‚ùå git not found"
            exit 1
          }

      - name: Verify dependencies (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          echo "üîç Verifying system dependencies..."
          
          # Check Node.js
          echo "‚úÖ Node.js: $(node --version)"
          
          # Check npm  
          echo "‚úÖ npm: $(npm --version)"
          
          # Check git
          if command -v git &> /dev/null; then
            echo "‚úÖ git: $(git --version)"
          else
            echo "‚ùå git not found"
            exit 1
          fi

      # Install dependencies
      - name: Install dependencies
        shell: bash  # npm works the same on all platforms
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      # Build the project
      - name: Build project
        shell: bash  # tsc works the same on all platforms
        run: |
          echo "üî® Building TypeScript project..."
          npm run build
          echo "‚úÖ Build completed successfully"

      # Verify build artifacts
      - name: Verify build artifacts (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Write-Output "üîç Verifying build artifacts..."
          
          if (-not (Test-Path "dist/index.js")) {
            Write-Output "‚ùå Missing dist/index.js"
            exit 1
          }
          Write-Output "‚úÖ dist/index.js exists"
          
          if (-not (Test-Path "dist/index.d.ts")) {
            Write-Output "‚ùå Missing dist/index.d.ts"
            exit 1
          }
          Write-Output "‚úÖ dist/index.d.ts exists"
          
      - name: Verify build artifacts (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          echo "üîç Verifying build artifacts..."
          [ -f "dist/index.js" ] && echo "‚úÖ dist/index.js exists" || { echo "‚ùå Missing dist/index.js"; exit 1; }
          [ -f "dist/index.d.ts" ] && echo "‚úÖ dist/index.d.ts exists" || { echo "‚ùå Missing dist/index.d.ts"; exit 1; }

      # Test MCP server startup
      - name: Test MCP server startup (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        timeout-minutes: 2
        run: |
          Write-Output "üöÄ Testing MCP server startup..."
          
          # Start server in background and test startup
          $job = Start-Job -ScriptBlock { 
            node dist/index.js 2>&1 | ForEach-Object { 
              if ($_ -match "Server running|MCP server|tools.*registered") { 
                Write-Output "SUCCESS: $_"
                return
              }
            }
          }
          
          # Wait for startup or timeout
          $timeout = 30
          $elapsed = 0
          $success = $false
          
          while ($elapsed -lt $timeout -and -not $success) {
            Start-Sleep -Seconds 1
            $elapsed++
            $output = Receive-Job -Job $job -ErrorAction SilentlyContinue
            if ($output -match "SUCCESS:") {
              Write-Output "‚úÖ MCP server started successfully"
              $success = $true
            }
          }
          
          Stop-Job -Job $job -ErrorAction SilentlyContinue
          Remove-Job -Job $job -ErrorAction SilentlyContinue
          
          if (-not $success) {
            Write-Output "‚ùå MCP server failed to start within ${timeout}s"
            exit 1
          }

      - name: Test MCP server startup (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        timeout-minutes: 2
        run: |
          echo "üöÄ Testing MCP server startup..."
          
          # Start server in background
          timeout 30s node dist/index.js > server.log 2>&1 &
          SERVER_PID=$!
          
          # Wait for startup indicators
          for i in {1..30}; do
            if grep -q "Server running\|MCP server\|tools.*registered" server.log 2>/dev/null; then
              echo "‚úÖ MCP server started successfully"
              kill $SERVER_PID 2>/dev/null || true
              exit 0
            fi
            sleep 1
          done
          
          echo "‚ùå MCP server failed to start within 30s"
          echo "Server log:"
          cat server.log 2>/dev/null || echo "No log file generated"
          kill $SERVER_PID 2>/dev/null || true
          exit 1

      # Test personas directory
      - name: Test personas directory (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Write-Output "üìÅ Testing personas directory..."
          if (Test-Path "personas") { 
            Write-Output "‚úÖ Personas directory exists"
            Get-ChildItem -Path "personas" -Filter "*.md" | ForEach-Object { Write-Output "üìÑ Found: $($_.Name)" }
          } else { 
            Write-Output "‚ùå Personas directory missing"
            exit 1 
          }

      - name: Test personas directory (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          echo "üìÅ Testing personas directory..."
          if [ -d "personas" ]; then
            echo "‚úÖ Personas directory exists"
            find personas -name "*.md" -type f | while read file; do echo "üìÑ Found: $(basename "$file")"; done
          else
            echo "‚ùå Personas directory missing"
            exit 1
          fi

      # Test package.json integrity
      - name: Test package.json integrity (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Write-Output "üìã Testing package.json integrity..."
          try {
            $pkg = Get-Content package.json | ConvertFrom-Json
            
            if ($pkg.name -ne "dollhousemcp") {
              Write-Output "‚ùå Invalid package name: '$($pkg.name)', expected 'dollhousemcp'"
              exit 1
            }
            Write-Output "‚úÖ Package name correct: $($pkg.name)"
            
            if ($pkg.main -ne "dist/index.js") {
              Write-Output "‚ùå Invalid main entry: '$($pkg.main)', expected 'dist/index.js'"
              exit 1
            }
            Write-Output "‚úÖ Main entry correct: $($pkg.main)"
            
          } catch {
            Write-Output "‚ùå Failed to parse package.json: $_"
            exit 1
          }
          
      - name: Test package.json integrity (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          echo "üìã Testing package.json integrity..."
          
          # Ultra-robust JSON parsing with multiple fallbacks
          if command -v jq &> /dev/null; then
            # Use jq if available (most reliable)
            NAME=$(jq -r '.name // ""' package.json 2>/dev/null)
            MAIN=$(jq -r '.main // ""' package.json 2>/dev/null)
          else
            # Fallback to node with enhanced error handling
            NAME=$(node -e 'try { console.log(require("./package.json").name || "") } catch(e) { console.log(""); process.exit(1) }' 2>/dev/null || echo "")
            MAIN=$(node -e 'try { console.log(require("./package.json").main || "") } catch(e) { console.log(""); process.exit(1) }' 2>/dev/null || echo "")
          fi
          
          # Validate parsed values
          if [ -z "$NAME" ]; then
            echo "‚ùå Failed to parse package.json name or name is empty"
            exit 1
          fi
          if [ -z "$MAIN" ]; then
            echo "‚ùå Failed to parse package.json main or main is empty"
            exit 1
          fi
          
          # Validate expected values
          if [ "$NAME" != "dollhousemcp" ]; then
            echo "‚ùå Invalid package name: '$NAME', expected 'dollhousemcp'"
            exit 1
          fi
          echo "‚úÖ Package name correct: $NAME"
          
          if [ "$MAIN" != "dist/index.js" ]; then
            echo "‚ùå Invalid main entry: '$MAIN', expected 'dist/index.js'"
            exit 1
          fi
          echo "‚úÖ Main entry correct: $MAIN"

      # Run tests
      - name: Run test suite
        shell: bash  # Jest works the same on all platforms
        run: |
          echo "üß™ Running test suite..."
          npm test
          echo "‚úÖ All tests passed"

      # Platform-specific additional tests
      - name: Platform-specific tests (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Write-Output "üîß Running Windows-specific tests..."
          Write-Output "‚úÖ Windows PowerShell syntax working correctly"
          Write-Output "‚úÖ Windows file operations functional"

      - name: Platform-specific tests (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          echo "üîß Running Unix-specific tests..."
          echo "‚úÖ Bash syntax working correctly"
          echo "‚úÖ Unix file operations functional"

      # Final validation
      - name: Final validation
        shell: bash  # Final summary works on all platforms
        run: |
          echo "üéâ Cross-platform testing completed successfully!"
          echo "Platform: ${{ matrix.platform }}"
          echo "Node.js: ${{ matrix.node-version }}"
          echo "All checks passed ‚úÖ"